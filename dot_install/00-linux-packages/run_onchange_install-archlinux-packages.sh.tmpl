#!/bin/bash

set -e

packages=(
    {{- range .packages.archlinux -}}
    {{ . }}
    {{ end -}}
    {{ if .wsl -}}
    wsl2-ssh-agent
    wsl-open
    {{- end }}
)

install_yay() {
    tmp=$(mktemp -d)
    trap "rm -rf ${tmp}" EXIT
    sudo pacman -Sy --needed git base-devel --noconfirm
    git clone https://aur.archlinux.org/yay.git "${tmp}"
    cd "${tmp}" || exit 1
    makepkg -si --noconfirm
}

pacman -Qs yay > /dev/null || install_yay
yay -Syyu --noconfirm --sudoloop

yay -Sy --needed --noconfirm --sudoloop ${packages[*]}
sudo libtool --finish /usr/lib/libfakeroot
